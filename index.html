<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live Mirror AI - V14.0 VIP</title>
    <style>
        /* M28 è¦–è¦ºå‚³æ’­ï¼šé»‘è‰²ç³»é«˜è³ªæ„Ÿè¨­è¨ˆ */
        :root { --bg-color: #000000; --panel-bg: #1a1a1a; --accent-color: #d4af37; /* æ”¹æˆé‡‘è‰²ä»£è¡¨ VIP */ --text-primary: #ffffff; }
        * { box-sizing: border-box; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; background: var(--bg-color); color: var(--text-primary); display: flex; justify-content: center; align-items: center; }
        #app-window { width: 100%; height: 100dvh; max-width: 500px; background: var(--panel-bg); display: flex; flex-direction: column; position: relative; overflow: hidden; }
        
        header { padding: 15px; text-align: center; border-bottom: 1px solid #333; font-weight: bold; flex: none; font-size: 18px; display: flex; justify-content: center; align-items: center; gap: 10px; color: var(--accent-color); }
        .version-tag { font-size: 10px; background: #333; padding: 2px 6px; border-radius: 4px; color: #aaa; }

        .stage { flex: 1; display: none; flex-direction: column; align-items: center; padding: 20px; overflow-y: auto; }
        .active { display: flex; animation: fadeIn 0.3s ease; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        .viewport { width: 100%; aspect-ratio: 3/4; background: #000; border-radius: 16px; border: 2px solid #444; overflow: hidden; position: relative; display: flex; justify-content: center; align-items: center; margin-bottom: 15px; flex: none; box-shadow: 0 4px 20px rgba(0,0,0,0.5); }
        video, img { width: 100%; height: 100%; object-fit: cover; }
        .mirror { transform: scaleX(-1); }

        .dna-section { width: 100%; background: #252525; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #444; }
        .dna-title { font-size: 14px; color: var(--accent-color); margin-bottom: 10px; font-weight: bold; display: flex; align-items: center; gap: 5px; }
        .tags-container { display: flex; flex-wrap: wrap; gap: 8px; }
        .tag-check { display: none; }
        .tag-label { padding: 6px 12px; background: #333; border-radius: 20px; font-size: 13px; color: #ccc; cursor: pointer; border: 1px solid #555; transition: all 0.2s; user-select: none; }
        .tag-check:checked + .tag-label { background: var(--accent-color); color: black; border-color: var(--accent-color); font-weight: bold; }

        /* é®ç½©å±¤ */
        #start-overlay, #question-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.96); z-index: 999; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 30px; text-align: center; }
        #question-overlay { display: none; z-index: 1000; } 

        .btn-action { width: 80%; padding: 14px 0; border-radius: 50px; border: none; background: var(--accent-color); color: black; font-size: 18px; font-weight: bold; cursor: pointer; margin-top: 10px; box-shadow: 0 0 20px rgba(212, 175, 55, 0.3); }
        .btn-secondary { background: #333; border: 1px solid #555; margin-top: 15px; color: white; }
        
        select.camera-select { width: 100%; padding: 12px; margin-bottom: 15px; background: #333; color: white; border: 1px solid #555; border-radius: 12px; font-size: 16px; outline: none; }
        
        /* 8å€‹é¢¨æ ¼çš„ Grid */
        .style-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px; width: 100%; padding-bottom: 40px;}
        .style-card { background: #2a2a2a; border: 1px solid #444; border-radius: 12px; padding: 12px 5px; cursor: pointer; text-align: center; font-size: 15px; position: relative; overflow: hidden; }
        .style-card:active { transform: scale(0.98); }
        
        /* ç‰¹æ®Šé¢¨æ ¼æ¨™è¨˜ */
        .style-real { border-color: #ff9900; }
        .style-tao { border-color: #ffffff; background: linear-gradient(45deg, #2a2a2a, #444); }
        .style-tao::after { content: "è–æ½”"; position: absolute; top: 0; right: 0; background: white; color: black; font-size: 10px; padding: 2px 6px; border-bottom-left-radius: 6px; font-weight: bold; }

        .gender-toggle { display: flex; gap: 10px; margin-bottom: 15px; width: 100%; }
        .gender-option { flex: 1; text-align: center; padding: 10px; background: #333; border-radius: 10px; border: 1px solid #555; cursor: pointer; font-weight: bold; color: #888; font-size: 15px; }
        .gender-option.selected { background: var(--accent-color); color: black; }
        
        /* å½ˆå‡ºæ–‡å­—å‹•ç•« */
        .pop-text { font-size: 20px; line-height: 1.6; animation: popIn 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
        @keyframes popIn { from { transform: scale(0.5); opacity: 0; } to { transform: scale(1); opacity: 1; } }

        #canvas { display: none; }
    </style>
</head>
<body>

<div id="app-window">
    <header>
        Live Mirror AI <span class="version-tag">V14.0 VIP</span>
    </header>

    <div id="start-overlay">
        <h1 style="color:white; margin-bottom:10px;">ğŸ‘‹ æ­¡è¿é«”é©—</h1>
        <p style="color:#aaa; margin-bottom:20px;">V14.0 æ–¹ç³æ¶µå°ˆå±¬ç‰ˆ</p>
        <div id="step-permission" style="width:100%; display:flex; justify-content:center;">
            <button class="btn-action" onclick="firstStart()">ğŸš€ å•Ÿå‹•ç›¸æ©Ÿ</button>
        </div>
        <div id="step-selection" style="display:none; width:100%;">
            <p style="color:white; margin-bottom:15px;">å·²åµæ¸¬åˆ°ç›¸æ©Ÿï¼š</p>
            <select id="camera-list" class="camera-select"></select>
            <div style="display:flex; justify-content:center;"><button class="btn-action" onclick="startSpecificCamera()">âœ… ç¢ºèª</button></div>
        </div>
        <p id="error-msg" style="color: #ff3366; font-size: 12px; margin-top: 20px; max-width: 80%;"></p>
    </div>

    <div id="question-overlay">
        <div id="q-step-1">
            <h1 style="font-size: 50px; margin-bottom: 10px;">ğŸ’</h1>
            <h2 style="color: var(--accent-color); margin-bottom: 15px;">åµæ¸¬åˆ° VIP æ°£å ´</h2>
            <p class="pop-text" style="color: #ddd; margin-bottom: 30px;">
                ç³»çµ±æƒæåˆ°ä¸€è‚¡éå‡¡çš„å„ªé›…æ°£è³ª...<br>
                å†’æ˜§è«‹å•ï¼Œæ‚¨æ˜¯å¦ç‚ºæˆ‘å€‘å°Šè²´çš„<br><br>
                <b style="color:white; font-size: 24px; border-bottom: 2px solid var(--accent-color);">ã€Œæ–¹ç³æ¶µ å°å§ã€</b> æœ¬äººï¼Ÿ
            </p>
            <button class="btn-action" onclick="answerQuestion(true)">ğŸŒ¹ æ˜¯çš„ï¼Œæˆ‘æ˜¯</button>
            <button class="btn-action btn-secondary" onclick="answerQuestion(false)">ğŸ¤” ä¸æ˜¯è€¶ï¼Œæˆ‘æ˜¯åˆ¥äºº</button>
        </div>
        <div id="q-step-2" style="display:none;">
            <h1 style="font-size: 50px; margin-bottom: 10px;">âœ¨</h1>
            <h2 style="color: var(--accent-color); margin-bottom: 15px;">ç¦®é‡ç¢ºèª</h2>
            <p id="praise-text" class="pop-text" style="color: #ddd; margin-bottom: 30px;">
                </p>
            <div style="width:70%; height:6px; background:#333; margin: 0 auto; border-radius:3px;">
                <div id="praise-bar" style="width:0%; height:100%; background:var(--accent-color); transition:width 2s;"></div>
            </div>
            <p style="color:#666; font-size:12px; margin-top:10px;">æ­£åœ¨è§£é–é ‚ç´šç®—åŠ›è³‡æº...</p>
        </div>
    </div>

    <div id="stage-1" class="stage">
        <div class="viewport">
            <video id="webcam" playsinline class="mirror" autoplay></video>
        </div>
        <button class="btn-action" onclick="capturePhoto()">ğŸ“¸ æ‹ç…§</button>
        <p style="margin-top:20px; font-size:14px; color:#666; cursor:pointer; text-decoration: underline;" onclick="location.reload()">[åˆ‡æ›é¡é ­]</p>
    </div>

    <div id="stage-2" class="stage">
        <div class="viewport" style="width: 140px; height: 140px; border-radius: 50%; border-color: var(--accent-color); margin-top: 5px;">
            <img id="preview-img" class="mirror" src="">
        </div>
        
        <div class="gender-toggle">
            <div class="gender-option" onclick="selectGender('boy')" id="btn-boy">ğŸ‘¦ ç”·ç”Ÿ</div>
            <div class="gender-option selected" onclick="selectGender('girl')" id="btn-girl">ğŸ‘§ å¥³ç”Ÿ</div>
        </div>

        <div class="dna-section">
            <div class="dna-title">ğŸ§¬ å‘Šè¨´ AI æ‚¨çš„ç‰¹å¾µ (ç²¾æº–åº¦UP)</div>
            <div class="tags-container">
                <label><input type="checkbox" class="tag-check" value="glasses"><span class="tag-label">ğŸ‘“ æˆ´çœ¼é¡</span></label>
                <label><input type="checkbox" class="tag-check" value="short hair"><span class="tag-label">ğŸ’‡ çŸ­é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="long hair" checked><span class="tag-label">ğŸ‘±â€â™€ï¸ é•·é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="curly hair"><span class="tag-label">â° æ²é«®</span></label>
                <label><input type="checkbox" class="tag-check" value="smile" checked><span class="tag-label">ğŸ˜„ å¾®ç¬‘</span></label>
                <label><input type="checkbox" class="tag-check" value="office lady"><span class="tag-label">ğŸ’¼ æ°£è³ª</span></label>
            </div>
        </div>

        <h3 style="width:100%; font-size:14px; color:#888; margin-bottom:10px;">é¸æ“‡é¢¨æ ¼ (å…±8æ¬¾)ï¼š</h3>
        <div class="style-grid">
            <div class="style-card" onclick="triggerTrap('pixar')">ğŸ§¸ çš®å…‹æ–¯é¢¨</div>
            <div class="style-card" onclick="triggerTrap('ghibli')">ğŸƒ å‰åœåŠ›é¢¨</div>
            <div class="style-card" onclick="triggerTrap('cyberpunk')">ğŸŒƒ è³½åšé¾å…‹</div>
            <div class="style-card" onclick="triggerTrap('oil')">ğŸ¨ æ¢µè°·æ²¹ç•«</div>
            <div class="style-card" onclick="triggerTrap('comic')">ğŸ’¥ ç¾å¼æ¼«ç•«</div>
            <div class="style-card" onclick="triggerTrap('ink')">ğŸ–Œï¸ æ±æ–¹æ°´å¢¨</div>
            <div class="style-card style-real" onclick="triggerTrap('real')">ğŸ“¸ çœŸäººæ“¬çœŸ</div>
            <div class="style-card style-tao" onclick="triggerTrap('taoist')">ğŸ•Šï¸ ç™½é™½è–æ½”</div>
        </div>
        <button style="margin-top:5px; background:transparent; border:none; color:#666; font-size:15px;" onclick="location.reload()">â¬…ï¸ é‡æ‹</button>
    </div>

    <div id="stage-3" class="stage" style="justify-content: center;">
        <h2>âš¡ AI æ­£åœ¨ç‚ºè²´è³“ç¹ªè£½...</h2>
        <div style="width:70%; height:6px; background:#333; margin-top:20px; border-radius:3px;">
            <div id="progress-bar" style="width:0%; height:100%; background:var(--accent-color); transition:width 0.3s;"></div>
        </div>
        <p id="prompt-debug" style="color:#666; font-size:12px; margin-top:15px; max-width:80%; text-align:center;">Loading...</p>
    </div>

    <div id="stage-4" class="stage">
        <h2>âœ¨ æ‚¨çš„å°ˆå±¬ç•«åƒ</h2>
        <div class="viewport">
            <img id="final-result" src="">
        </div>
        <p style="color: var(--accent-color); font-weight: bold; font-size: 18px; margin-top: 5px;">ğŸ‘‡ é•·æŒ‰åœ–ç‰‡å„²å­˜ ğŸ‘‡</p>
        <div style="font-size: 13px; color: #888; margin-top: 20px; border-top: 1px solid #333; padding-top: 15px; width: 100%; text-align: center;">
            åˆ†äº«é€£çµï¼š
            <div id="qrcode-container" style="margin-top: 10px; background: white; padding: 10px; display: inline-block; border-radius: 12px;"></div>
        </div>
        <button class="btn-action" onclick="location.reload()" style="background:#333; color:white; font-size:16px; margin-top: 20px;">ğŸ”„ å†ç©ä¸€æ¬¡</button>
    </div>

    <canvas id="canvas"></canvas>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

<script>
    const video = document.getElementById('webcam'), canvas = document.getElementById('canvas'), previewImg = document.getElementById('preview-img'), finalImg = document.getElementById('final-result'), cameraList = document.getElementById('camera-list'), errorMsg = document.getElementById('error-msg');
    let currentGender = 'girl'; 
    let pendingStyle = ''; 

    async function firstStart() {
        errorMsg.innerText = "";
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: true });
            await listCameras();
            stream.getTracks().forEach(track => track.stop());
            document.getElementById('step-permission').style.display = 'none';
            document.getElementById('step-selection').style.display = 'block';
        } catch (err) { errorMsg.innerText = "å•Ÿå‹•å¤±æ•—ï¼š" + err.message + "\nè«‹ç”¨ Chrome é–‹å•Ÿ"; }
    }
    async function listCameras() {
        const devices = await navigator.mediaDevices.enumerateDevices();
        const videoDevices = devices.filter(device => device.kind === 'videoinput');
        cameraList.innerHTML = '';
        videoDevices.forEach((device, index) => {
            const option = document.createElement('option');
            option.value = device.deviceId;
            let label = device.label || `ç›¸æ©Ÿ ${index + 1}`;
            if (label.toLowerCase().includes('back') || label.includes('å¾Œ')) label = "ğŸ“¸ å¾Œç½®é¡é ­";
            else if (label.toLowerCase().includes('front') || label.includes('å‰')) label = "ğŸ‘¤ å‰ç½®è‡ªæ‹";
            option.text = label;
            cameraList.appendChild(option);
        });
    }
    async function startSpecificCamera() {
        const deviceId = cameraList.value;
        try {
            const stream = await navigator.mediaDevices.getUserMedia({ video: { deviceId: { exact: deviceId } } });
            video.srcObject = stream;
            document.getElementById('start-overlay').style.display = 'none';
            switchStage('stage-1');
        } catch (err) {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({ video: true });
                video.srcObject = stream;
                document.getElementById('start-overlay').style.display = 'none';
                switchStage('stage-1');
            } catch (fatalErr) { alert("ç„¡æ³•å•Ÿå‹•ç›¸æ©Ÿ"); }
        }
    }
    function selectGender(g) { currentGender = g; document.getElementById('btn-boy').classList.toggle('selected', g==='boy'); document.getElementById('btn-girl').classList.toggle('selected', g==='girl'); }
    function capturePhoto() {
        canvas.width = video.videoWidth; canvas.height = video.videoHeight;
        const ctx = canvas.getContext('2d'); ctx.translate(canvas.width, 0); ctx.scale(-1, 1);
        ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
        previewImg.src = canvas.toDataURL('image/png'); switchStage('stage-2');
    }

    function getDNA() {
        const checkboxes = document.querySelectorAll('.tag-check:checked');
        let tags = [];
        checkboxes.forEach(cb => tags.push(cb.value));
        return tags.join(", ");
    }

    // ============================================
    // V14.0 VIP æ””æˆªæ©Ÿåˆ¶
    // ============================================
    function triggerTrap(styleKey) {
        pendingStyle = styleKey; 
        document.getElementById('question-overlay').style.display = 'flex';
        document.getElementById('q-step-1').style.display = 'block';
        document.getElementById('q-step-2').style.display = 'none';
    }

    function answerQuestion(isShe) {
        document.getElementById('q-step-1').style.display = 'none';
        document.getElementById('q-step-2').style.display = 'block';
        
        const textEl = document.getElementById('praise-text');
        
        if (isShe) {
            // å›ç­”ã€Œæ˜¯æœ¬äººã€: å°Šæ¦®ç¦®é‡
            textEl.innerHTML = "<b>æ­¡è¿æ–¹å°å§ï¼</b>ğŸŒ¹<br>ç³»çµ±å·²ç¢ºèªæ‚¨çš„ VIP èº«ä»½ã€‚<br>æ‚¨çš„æ°£è³ªå„ªé›…éå‡¡ï¼Œ<br>AI å·²è‡ªå‹•å‡ç´šç‚º<b>ã€Œé ‚ç´šæ¸²æŸ“æ¨¡å¼ã€</b>ï¼Œ<br>å°ˆç‚ºè¥¯æ‰˜æ‚¨çš„å…‰å½©è€Œè¨­ï¼";
        } else {
            // å›ç­”ã€Œä¸æ˜¯ã€: ä¾ç„¶è®šç¾
            textEl.innerHTML = "çœŸçš„å—ï¼ŸğŸ¤”<br>ä½†ç³»çµ±é¡¯ç¤ºæ‚¨çš„<b>ã€Œå„ªé›…æŒ‡æ•¸ã€</b><br>å·²ç¶“é”åˆ°æ–¹å°å§çš„ VIP ç­‰ç´šï¼<br>AI åˆ¤å®šæ‚¨ç‚º<b>ã€Œç‰¹ç´šè²´è³“ã€</b>ï¼Œ<br>æˆ‘å€‘ä¾ç„¶æœƒç”¨æœ€é«˜è¦æ ¼ç‚ºæ‚¨ä½œç•«ï¼";
        }

        const bar = document.getElementById('praise-bar');
        setTimeout(() => { bar.style.width = '100%'; }, 100);

        // 3ç§’å¾Œé–‹å§‹
        setTimeout(() => {
            document.getElementById('question-overlay').style.display = 'none';
            realGenerate();
        }, 3500);
    }

    function realGenerate() {
        switchStage('stage-3'); 
        simulateProgress();

        let styleKey = pendingStyle;
        let genderBase = currentGender === 'boy' ? "handsome man, male" : "beautiful woman, female";
        let dna = getDNA();
        
        let basePrompt = "";
        
        // 1-6 åŸæœ¬é¢¨æ ¼
        if(styleKey === 'pixar')    basePrompt = `cute 3d pixar style ${genderBase}, ${dna}, studio lighting, big eyes, 8k`;
        else if(styleKey === 'ghibli')   basePrompt = `studio ghibli anime portrait of ${genderBase}, ${dna}, hayao miyazaki style, watercolor background`;
        else if(styleKey === 'cyberpunk') basePrompt = `cyberpunk portrait of ${genderBase}, ${dna}, neon lights, mechanical parts, futuristic city`;
        else if(styleKey === 'oil')      basePrompt = `van gogh oil painting portrait of ${genderBase}, ${dna}, thick brushstrokes, artistic, starry night`;
        else if(styleKey === 'comic')    basePrompt = `american comic superhero ${genderBase}, ${dna}, bold lines, halftone dots, marvel style`;
        else if(styleKey === 'ink')      basePrompt = `chinese ink wash painting portrait of ${genderBase}, ${dna}, black and white, sumi-e, artistic, red stamp`;
        
        // 7 çœŸäººç‰ˆ
        else if(styleKey === 'real') {
            basePrompt = `(masterpiece), best quality, realistic photo of a ${genderBase}, ${dna}, highly detailed face, dslr, 8k, raw photo, soft lighting, looking at camera`;
        }
        
        // 8 ç™½é™½è–æ½” (ä¸€è²«é“é¢¨æ ¼)
        else if(styleKey === 'taoist') {
            basePrompt = `(masterpiece), traditional chinese ancient style portrait of ${genderBase}, ${dna}, wearing white hanfu, taoist robe, dignified pose, righteous aura, ethereal atmosphere, soft lighting, temple background, lotus, serene expression, hd, 8k`;
        }

        document.getElementById('prompt-debug').innerText = "AI æ­£åœ¨é‹ç®—ï¼š" + (dna ? dna : "è²´è³“ç‰¹å¾µ") + " ...";

        const aiUrl = `https://image.pollinations.ai/prompt/${encodeURIComponent(basePrompt)}?width=1024&height=1024&seed=${Math.floor(Math.random()*9999)}&nologo=true`;

        const img = new Image();
        img.onload = () => { finalImg.src = aiUrl; document.getElementById("qrcode-container").innerHTML = ""; new QRCode(document.getElementById("qrcode-container"), { text: window.location.href, width: 120, height: 120 }); switchStage('stage-4'); };
        img.onerror = () => { alert("AI å¿™ç¢Œä¸­ï¼Œè«‹é‡è©¦"); location.reload(); };
        img.src = aiUrl;
    }

    function simulateProgress() { const bar = document.getElementById('progress-bar'); let w = 0; const int = setInterval(() => { if(w>=90) clearInterval(int); w+=10; bar.style.width=w+'%'; }, 300); }
    function switchStage(id) { document.querySelectorAll('.stage').forEach(el => { el.style.display = 'none'; el.classList.remove('active'); }); const target = document.getElementById(id); target.style.display = 'flex'; setTimeout(()=>target.classList.add('active'), 10); }
</script>
</body>
</html>